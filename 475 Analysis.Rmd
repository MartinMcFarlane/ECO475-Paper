---
title: "475 Analysis"
output: html_document
date: "2024-01-31"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Setup

#load packages
library(quantmod)
library(expss)
library(vtable)
library(xts)
library(tidyr)
library(tidyverse)
library(dplyr)
library(stringi)
library(estimatr)
library(stargazer)


```

```{r}
##################################################
## PART A: SETUP & DATA CLEANING                 #
##################################################

# Load primary dataset
housing.raw <- read.csv("Data/housing_indicators_micro.csv")
cols <- c("Census.year..2.", "GEO", "DGUID", "Housing.indicators..9.",
          "Tenure..4.", "VALUE") # cols to keep
housing <- housing.raw[,cols] 
names(housing) <- c("Year", "GEO", "DGUID", "Indicator", "Tenure", "VALUE")

```

```{r}
housing.w <- pivot_wider(housing, id_cols=c("Year", "GEO", "DGUID","Tenure"),
                         names_from="Indicator", values_from="VALUE")
cols <- c("Year", "GEO", "DGUID", "Tenure", "tot.hh", "inadq.pc", "unsuit.pc",
          "unafford.pc", "core.nd", "core.nd.pc", "inadq", "unsuit", "unafford")
names(housing.w) <- cols

housing.w$Tenure[housing.w$Tenure == "Dwelling provided by the local government, First Nation or Indian band"] <- "Government provided"

housing.w$Tenure[housing.w$Tenure == "Total - Tenure"] <- "Total"

# drop government provided tenure values - not relevant
housing.w <- housing.w %>% filter(Tenure!="Government provided")

# replace NAs with zeros

housing.w <- housing.w %>% replace_na(list(tot.hh=0))
#housing.w <- housing.w %>% replace_na(list(tot.hh=0, inadq.pc=0.0, unsuit.pc=0.0, unafford.pc=0.0,
#                              core.nd=0, core.nd.pc=0.0, inadq=0, unsuit=0, unafford=0))

# drop subdivisions where tot.hh for total tenure == 0
housing.total <- filter(housing.w, Tenure == "Total" )
# filter df by Tenure == Tenure total
for (i in 1:nrow(housing.total)) {
  if (housing.total[i, "tot.hh"] == 0) {
    yr <- as.numeric(housing.total[i, "Year"]) # if tot.hh == 0, collect year and DGUID
    geo_id <- as.character(housing.total[i, "DGUID"])
    
    # in orig df, drop observation if year and DGUID match
    housing.w <- housing.w %>% subset(!(DGUID==geo_id & Year==yr))
  }
}



```

```{r}
# get summary statistics: group by year-tenure type

vars.of.int <- c("tot.hh", "inadq.pc", "unsuit.pc", "unafford.pc", "inadq",
                 "unsuit", "unafford")

stats <- c("mean(x)", "sd(x)", "min(x)", "median(x)", "max(x)")
stats.label <- c("Mean", "Std. Dev.", "Min", "Median", "Max")

sumtable(housing.w, vars=vars.of.int, summ=stats, summ.names=stats.label, group="Tenure", out="browser")
```

```{r}
census <- read.csv("C:/Users/marti/Documents/_ECO475 Term Paper/Data/census_2021.csv")
```

```{r}
# Filter Census data to geos, variables of interest

# characteristics/controls of interest
chars_of_int <- c(1,2,3,1403,1526,6,80,81,244,
                  360,1457,1458,1459,1460,
                  1461,1462,1463,1464,2016,2017,
                  2230) 
census.f <- census %>% filter(GEO_LEVEL == "Census subdivision" & CHARACTERISTIC_ID %in% chars_of_int)

# Grab only columns of interest
cols_of_int <- c("DGUID", "GEO_NAME", "CHARACTERISTIC_ID", "CHARACTERISTIC_NAME",
                 "C1_COUNT_TOTAL", "C10_RATE_TOTAL")
census.f <- census.f[,cols_of_int]


# Create value column. If population, use count var. Else, use rate
census.f$VALUE <- NA

for (i in 1:nrow(census.f)) {
if (census.f[i,"CHARACTERISTIC_ID"] %in% c(1,2,3)) {
  census.f[i,"VALUE"] <- census.f[i,"C1_COUNT_TOTAL"]
} else {
  census.f[i,"VALUE"] <- census.f[i,"C10_RATE_TOTAL"]
}
}

```

```{r}
# Convert to wide
## Change characteristic names so they are shorter and more manageable
name.chg <- list(c("Population, 2021", "pop21"),
                 c("Population, 2016", "pop16"),
                 c("Population percentage change, 2016 to 2021", "pop_chg"),
                 c("Population density per square kilometre", "pop_dens"),
                 c("    Married couples", "married"),
                 c("      With children", "marr_w_child"),
                 c("  Median after-tax income of household in 2020 ($)", "med_at_inc"),
                 c("Prevalence of low income based on the Low-income cut-offs, after tax (LICO-AT) (%)", "bel_lico"),
                 c("  Indigenous identity", "indig"),
                 c("  15 to 24 years", "age_15to24"),
                 c("  25 to 34 years", "age_25to34"),
                 c("  35 to 44 years", "age_35to44"),
                 c("  45 to 54 years", "age_45to54"),
                 c("  55 to 64 years", "age_55to64"),
                 c("  65 to 74 years", "age_65to74"),
                 c("  75 to 84 years", "age_75to84"),
                 c("  85 years and over", "age_85_plus"),
                 c("  Not Canadian citizens", "non_cdn"),
                 c("  High (secondary) school diploma or equivalency certificate", "he_highschool"),
                 c("  Postsecondary certificate, diploma or degree", "he_postsec"),
                 c("Unemployment rate", "unemp"))

for (name in name.chg) {
  census.f[census.f$CHARACTERISTIC_NAME == name[1], "CHARACTERISTIC_NAME"] <- name[2]
}

## Create wide dataset
census.w <- census.f %>% pivot_wider(id_cols=c("DGUID", "GEO_NAME"),
                         names_from="CHARACTERISTIC_NAME", values_from="VALUE")

# Merge with housing indicator set
full.df <- left_join(housing.w, census.w, by=join_by(DGUID))

```

```{r}
geo_list <- as.data.frame(unique(full.df$GEO_NAME))
```

```{r}
# EXTRA VARIABLES TO CREATE
## Indigenous reserve - if GEO_NAME contains (IRI)
full.df$indig_res = 0
for (i in 1:nrow(full.df)){
  recoded_str <- as.character(full.df[i,"GEO_NAME"]) %>% iconv(from="utf-8", to="ascii")
  sample_s <- str_sub(recoded_str, -6)
  if (grepl("(IRI)", sample_s)) {
    full.df[i,"indig_res"] <- 1
  }
} # the str_sub fcn does not like french accented characters. Function iconv converted the
  # text to ascii which it did accept without issue. 



## Provinces
### Note: Province codes are a two-character string starting AFTER the first 9 "Fixed width" 
### characters in the DGUID.
provinces <- list(c(10, "NL"),
                  c(11, "PEI"),
                  c(12, "NS"),
                  c(13, "NB"),
                  c(24, "QC"),
                  c(35, "ON"),
                  c(46, "MB"),
                  c(47, "SK"),
                  c(48, "AB"),
                  c(59, "BC"),
                  c(60, "YT"),
                  c(61, "NT"),
                  c(62, "NU"))

full.df$prov <- NA
for (i in 1:nrow(full.df)){
  pr_sub <- as.numeric(substr(full.df[i,"DGUID"], 10, 11))
  for (j in provinces){
    if (pr_sub == j[1]){
      full.df[i,"prov"] <- j[2]
    }
  }
}

## Population Bins

### Going to group as follows based on 2021 pop: 0 to <1000, 1000 to <2500, 
### 2500 to <10000, 10000 to <50000, 50000 to <200000, >=200000

### order: list(var_name, lower_bound, upper_bound)
city_params <- list(
  list("pop_bel_1k", 0, 1000, "Below 1000"),
  list("pop_1k_2.5k", 1000, 2500, "1000 to 2500"),
  list("pop_2.5k_10k", 2500, 10000, "2500 to 10,000"),
  list("pop_10k_50k", 10000, 50000, "10,000 to 50,000"),
  list("pop_50k_200k", 50000, 200000, "50,000 to 200,000"),
  list("pop_abv_200k", 200000, max(full.df$pop21, na.rm=TRUE) + 1, "over 200,000") # max value plus 1, see comment below 
  ### because will use < for second value. see code below.
)

full.df$pop.bin <- "" # Adding a category column for the dummies above to assist group_by's

for (var in city_params){
  col_nam <- as.character(var[1])
  cat_label <- as.character(var[4])
  full.df[,col_nam] <- 0
  for (i in 1:nrow(full.df)){
    if(is.na(full.df[i,"pop21"])){
      next
    }
    pop_val <- as.numeric(full.df[i,"pop21"])
    if ((pop_val >= var[2]) & (pop_val < var[3])){
      full.df[i,col_nam] <- 1
      full.df[i, "pop.bin"] <- cat_label
    }
  }
}

## Time variable, 0 if 2016 and 1 if 2021
full.df <- full.df %>%
  mutate(time = ifelse(Year == 2021, 1, 0))

```

```{r}
# How many unsuitable NA values are there by population bin?


full.df[full.df$Tenure == "Total",] %>%
  group_by(pop.bin) %>%
  summarise(sum_na = sum(is.na(unsuit)))

sum(full.df$pop_1k_2.5k)
# 3267/4740 observations below 1000 have NA for count of unsuitable housing...
# whereas less than 10% of 1000 to 2500 have NAs

```

```{r}
# If I drop all obs with NA unsuit, unafford, inadq, how many are left?
df.no.nas <- full.df[!(is.na(full.df$unafford)),]
df.no.nas <- df.no.nas[!(is.na(df.no.nas$unsuit)),]
df.no.nas <- df.no.nas[!(is.na(df.no.nas$inadq)),]

print(nrow(df.no.nas))

# About 9786 out of 26913
```
```{r}
# Distribution of NA rows by pop bin
df.nas <- full.df[(is.na(full.df$unafford)),]
df.nas <- df.nas[(is.na(df.nas$unsuit)),]
df.nas <- df.nas[(is.na(df.nas$inadq)),]

df.nas %>% ggplot(aes(x=pop.bin)) + geom_bar(fill="blue") + theme_classic()
```


```{r}
##################################################
## PART B: ANALYSIS                              #
##################################################

# How do the housing indicators compare province-by-province? Use pop-based weights
# and equal weight by subdivision to analyze differences?
```

```{r}
# Regression analysis using OLS model - housing indicators ~ pop size, covar's
# Do separate regressions for owner sample, renter sample, whole sample
```

```{r}
# Regress restricting to 2016 and 2021 samples, drop where unafford == NA.
# Use for reporting unweighted means of each community group, over time 

model.tot2021 <- df.no.nas[(df.no.nas$Tenure == "Total") & (df.no.nas$Year == 2021),] %>% 
  lm(formula = unafford.pc ~ pop_bel_1k + pop_1k_2.5k + pop_2.5k_10k + pop_10k_50k + pop_50k_200k)

print("FIRST REGRESSION")
summary(model.tot2021)

model.tot2016 <- df.no.nas[(df.no.nas$Tenure == "Total") & (df.no.nas$Year == 2016),] %>% 
  lm(formula = unafford.pc ~ pop_bel_1k + pop_1k_2.5k + pop_2.5k_10k + pop_10k_50k + pop_50k_200k)

print("SECOND REGRESSION")
summary(model.tot2016)
```

```{r}
### MAIN Regression - How have housing indicators changed over time for each group ###

## 1. UNAFFORDABLE HOUSING 
### w/o size/year interactions
model.tot1 <- df.no.nas[(df.no.nas$Tenure == "Total"),] %>% 
  lm(formula = unafford.pc ~ pop_bel_1k + pop_1k_2.5k + pop_2.5k_10k + pop_10k_50k + pop_50k_200k + time)

summary(model.tot1)
```


```{r}
### with interactions
model.tot2 <- df.no.nas[(df.no.nas$Tenure == "Total"),] %>% 
  lm(formula = unafford.pc ~ pop_bel_1k + pop_1k_2.5k + pop_2.5k_10k + pop_10k_50k + pop_50k_200k + time +
       time*pop_bel_1k + time*pop_1k_2.5k + time*pop_2.5k_10k + time*pop_10k_50k + time*pop_50k_200k)

summary(model.tot2)
```
Unconditional on covariates, change over the censuses of housing unaffordability  
not statistically different from the change in Canada's largest cities. 

```{r}
### with covariates (non-family, age)
model.tot3 <- df.no.nas[(df.no.nas$Tenure == "Total"),] %>% 
  lm(formula = unafford.pc ~ pop_bel_1k + pop_1k_2.5k + pop_2.5k_10k + pop_10k_50k + pop_50k_200k + time +
       time*pop_bel_1k + time*pop_1k_2.5k + time*pop_2.5k_10k + time*pop_10k_50k + time*pop_50k_200k +
       med_at_inc + bel_lico + non_cdn + he_highschool + he_postsec + unemp)

summary(model.tot3)
```
Income, population density and education controls eliminate mean differences between
the population groups. Implies unaffordability not due to differences in population size per se,
but rather associated with income and education differences. I tried removing population density
and mean differences returns to significance. Conditional on these controls, little to no differences
in housing affordability for settlements > 10K people.

```{r}
### with family, age covariates
model.tot4 <- df.no.nas[(df.no.nas$Tenure == "Total"),] %>% 
  lm(formula = unafford.pc ~ pop_bel_1k + pop_1k_2.5k + pop_2.5k_10k + pop_10k_50k + pop_50k_200k + time +
       time*pop_bel_1k + time*pop_1k_2.5k + time*pop_2.5k_10k + time*pop_10k_50k + time*pop_50k_200k +
       med_at_inc + bel_lico + non_cdn + he_highschool + he_postsec + unemp + married +
       marr_w_child + age_15to24 + age_25to34 + age_35to44 + age_45to54 + age_55to64 +
       age_65to74 + age_75to84 + age_85_plus)

summary(model.tot4)
```
Ages have negative association with housing affordability, controlling for the other factors. 
But having children has a positive association...

```{r}
### Fixed Effects with Indigenous community indicator
model.tot5 <- df.no.nas[(df.no.nas$Tenure == "Total"),] %>% 
  lm(formula = unafford.pc ~ pop_bel_1k + pop_1k_2.5k + pop_2.5k_10k + pop_10k_50k + pop_50k_200k + time +
       time*pop_bel_1k + time*pop_1k_2.5k + time*pop_2.5k_10k + time*pop_10k_50k + time*pop_50k_200k +
       med_at_inc + bel_lico + non_cdn + he_highschool + he_postsec + unemp + married +
       marr_w_child + age_15to24 + age_25to34 + age_35to44 + age_45to54 + age_55to64 +
       age_65to74 + age_75to84 + age_85_plus + factor(prov))

summary(model.tot5)
```
Provincial fixed effects eliminate significance of estimates for all population
groupings except for 1K-2.5K group.

```{r}
### One last check: restricted to 2021 sample, with % pop change as regressor
df.2021 <- df.no.nas[(df.no.nas$Year == 2021),]

model.pop.chg <- df.2021 %>% 
  lm(formula = unafford.pc ~ pop_chg + pop_bel_1k + pop_1k_2.5k + pop_2.5k_10k + pop_10k_50k + pop_50k_200k +
       med_at_inc + bel_lico + non_cdn + he_highschool + he_postsec + unemp + married +
       marr_w_child + age_15to24 + age_25to34 + age_35to44 + age_45to54 + age_55to64 +
       age_65to74 + age_75to84 + age_85_plus + factor(prov))

summary(model.pop.chg)
```

```{r}
### Move to stargazer table
stargazer(model.tot1, model.tot2, model.tot3, model.tot4, align=TRUE,
          keep=c("pop_bel_1k","pop_1k_2.5k","pop_2.5k_10k","pop_10k_50k",
                 "pop_50k_200k", "time", "non_cdn", "he_highschool", "he_postsec",
                 "married", "marr_w_child"), column.sep.width = "0.1pt", font.size="scriptsize",
          float.env="sidewaystable")
```


```{r}
# Distributions of the rates of the housing indicators

## Unaffordable housing
hist.d <- df.no.nas[(df.no.nas$Tenure == "Total"),]
hist(hist.d$unafford.pc, main="Total Sample, unafford.pc") # need to separate by tenure type

hist.d <- df.no.nas[(df.no.nas$Tenure == "Owner"),]
hist(hist.d$unafford.pc, main="Owner Sample, unafford.pc")

hist.d <- df.no.nas[(df.no.nas$Tenure == "Renter"),]
hist(hist.d$unafford.pc, main="Renter Sample, unafford.pc")

```

```{r}

```


```{r}
### HELPER FUNCTIONS ###
#function encode_dummy(data, new_var, logical) # use logical to code dummy variable new_var = 1


```


```{}
# SCRAP CODE

housing.w <- apply_labels(housing.w,
  tot.hh = "Total Households",
  inadq.pc = "Inadequate Housing (%)",
  inadq = "Inadequate Housing (Count)",
  unsuit.pc = "Unsuitable Housing (%)",
  unsuit = "Unsuitable Housing (Count)",
  unafford.pc = "Unaffordable Housing (%)",
  unafford = "Unaffordable Housing (Count)",
  core.nd.pc = "In Core Housing Need (%)",
  core.nd = "In Core Housing Need (Count)"
)
```

